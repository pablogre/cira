<!-- templates/presupuesto.html -->
{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- Informaci√≥n del Cliente -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
               <h4>Cliente: <span id="cliente_nombre">{{ cliente.apeynom }}</span></h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Direcci√≥n:</strong> {{ cliente.direccion }}</p>
                        <p><strong>Localidad:</strong> {{ cliente.localidad }}</p>
                        <p>Tel√©fono: <span id="cliente_telefono">{{ cliente.telefono }}</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Aseguradora:</strong> {{ cliente.aseguradora }}</p>
                        <p>Email: <span id="cliente_email">{{ cliente.email }}</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Formulario para agregar items -->
    <div class="col-md-5">
        <div class="card">
            <div class="card-header">
                <h5>Agregar Item al Presupuesto</h5>
            </div>
            <div class="card-body">
                <form id="presupuestoForm">
                    <input type="hidden" id="id_cli" name="id_cli" value="{{ cliente.id_cli }}">
                    
                    <div class="mb-3">
                        <label for="marca" class="form-label">Marca:</label>
                        <input type="text" class="form-control uppercase" name="marca" id="marca" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-7 mb-3">
                            <label for="modelo" class="form-label">Modelo:</label>
                            <input type="text" class="form-control uppercase" name="modelo" id="modelo" required>
                        </div>
                        <div class="col-md-5 mb-3">
                            <label for="patente" class="form-label">Patente:</label>
                            <input type="text" class="form-control uppercase" name="patente" id="patente" required>
                        </div>
                    </div>

                    
                    <div class="mb-3">
                        <label for="accion" class="form-label">Acci√≥n:</label>
                        <select class="form-select" name="accion" id="accion" required>
                            <option value="">Seleccione...</option>
                            <option value="Desarrollar">Desabollar</option>
                            <option value="Desarrollar y Pintar">Desabollar y Pintar</option>
                            <option value="Cambiar">Cambiar</option>
                            <option value="Cambiar y Pintar">Cambiar y Pintar</option>
                            <option value="Reparar y Pintar">Reparar y Pintar</option>
                            <option value="Pintar">Pintar</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="partes" class="form-label">Partes:</label>
                            <select class="form-select" name="partes" id="partes">
                                <option value="">Seleccione...</option>
                                <option value="Ba√∫l / Tapa de ba√∫l">Ba√∫l / Tapa de ba√∫l</option>
                                <option value="Burlete Puerta delantera">Burlete Puerta delantera</option>
                                <option value="Burlete Puerta trasera">Burlete Puerta trasera</option>
                                <option value="Capot">Capot</option>
                                <option value="Condesador">Condesador</option>
                                <option value="Cristal puerta delantera">Cristal puerta delantera</option>
                                <option value="Cristal puerta trasera">Cristal puerta trasera</option>
                                <option value="Espejo Retrovisor">Espejo Retrovisor</option>
                                <option value="Faro Trasero">Faro Trasero</option>
                                <option value="Guardabarro Delantero">Guardabarro Delantero</option>
                                <option value="Guardabarro trasero">Guardabarro Trasero</option>
                                <option value="Guardplast de guardabarro delantero">Guardplast de guardabarro delantero</option>
                                <option value="Guardplast de guardabarro trasero">Guardplast de guardabarro trasero</option>
                                <option value="Luneta">Luneta</option>
                                <option value="Manija de Puerta">Manija de Puerta</option>
                                <option value="Media Coliza exterior puerta delantera">Media Coliza exterior puerta delantera</option>
                                <option value="Media Coliza exterior puerta trasera">Media Coliza exterior puerta trasera</option>
                                <option value="Moldura de paragolpe delantero">Moldura de paragolpe delantero</option>
                                <option value="Moldura de paragolpe trasero">Moldura de paragolpe trasero</option>
                                <option value="Moldura de puerta delantera">Moldura de puerta delantera</option>
                                <option value="Moldura de puerta trasera">Moldura de puerta trasera</option>
                                <option value="Moldura inferior de paragolpe delantero">Moldura inferior de paragolpe delantero</option>
                                <option value="Moldura inferior de paragolpe trasero">Moldura inferior de paragolpe trasero</option>
                                <option value="√ìptica Delantera">√ìptica Delantera</option>
                                <option value="Paragolpe Delantero">Paragolpe Delantero</option>
                                <option value="Paragolpe Trasero">Paragolpe Trasero</option>
                                <option value="Parante de techo">Parante de techo</option>
                                <option value="Parrilla Frontal">Parrilla Frontal</option>
                                <option value="Pilar A">Pilar A</option>
                                <option value="Pilar B">Pilar B</option>
                                <option value="Pilar C">Pilar C</option>
                                <option value="Port√≥n trasero">Port√≥n trasero</option>
                                <option value="Puerta Delantera">Puerta Delantera</option>
                                <option value="Puerta Trasera">Puerta Trasera</option>
                                <option value="Radiador">Radiador</option>
                                <option value="Rejilla Inferior de Paragolpes">Rejilla Inferior de Paragolpes</option>
                                <option value="Rompe niebla Delantero">Rompe niebla Delantero</option>
                                <option value="Rompe niebla Trasero">Rompe niebla Trasero</option>
                                <option value="Socalo">Socalo</option>
                                <option value="Soporte de paragolpe delantero">Soporte de paragolpe delantero</option>
                                <option value="Soporte de paragolpe trasero">Soporte de paragolpe trasero</option>
                                <option value="Tapa de Combustible">Tapa de Combustible</option>
                                <option value="Techo">Techo</option>
                                <option value="Z√≥calo">Z√≥calo</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lateral" class="form-label">Lateral:</label>
                            <select class="form-select" name="lateral" id="lateral">
                                <option value="">Seleccione...</option>
                                <option value="Lateral Izquierdo/a">Lateral Izquierdo/a</option>
                                <option value="Lateral Derecho/a">Lateral Derecho/a</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="marca" class="form-label">Item:</label>
                        <input type="text" class="form-control uppercase" name="item" id="item">
                    </div>
                    <div class="mb-3">
                        <label for="importe" class="form-label">Importe:</label>
                        <input type="number" class="form-control" name="importe" id="importe" step="1000" min="0">
                    </div>
                    
                    <button type="submit" class="btn btn-success">Agregar Item</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Grilla de presupuestos -->
    <div class="col-md-7">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Items del Presupuesto</h5>
                <button class="btn btn-secondary mt-3" onclick="imprimirPresupuesto()">Imprimir</button>
                <div id="totalPresupuesto" class="h5 mb-0 text-primary">$0.00</div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="grilla_items" class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Veh√≠culo</th>
                                <th>Parte</th>
                                <th>Importe</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaPresupuestos">
                            <tr>
                                <td colspan="5" class="text-center text-muted">Ingrese una patente para ver los items del presupuesto.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <a href="/" class="btn btn-secondary">Nuevo Cliente</a>
    </div>
</div>

<!-- SweetAlert2 CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.1/sweetalert2.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.1/sweetalert2.min.css">

<script>
// Variables globales
const clienteId = {{ cliente.id_cli }};
let patenteActual = '';

// Actualiza la tabla de presupuestos seg√∫n la patente ingresada
function actualizarPresupuestos() {
    const patente = document.getElementById('patente').value.trim();

    if (!patente) {
        limpiarTabla();
        return;
    }

    patenteActual = patente;
    mostrarLoading();

    fetch('/obtener_presupuestos', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            id_cli: clienteId,
            patente: patente,
            fecha: new Date().toISOString().split('T')[0]
        })
    })
    .then(response => {
        if (!response.ok) throw new Error(`Error en la respuesta: ${response.status}`);
        return response.json();
    })
    .then(data => {
        renderizarTabla(data.presupuestos, data.total);
    })
    .catch(error => {
        console.error('Error al obtener presupuestos:', error);
        mostrarErrorTabla('Error al cargar los presupuestos.');
    });
}

function limpiarTabla() {
    const tbody = document.getElementById('tablaPresupuestos');
    tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">
        Ingrese una patente para ver los items del presupuesto.</td></tr>`;
    actualizarTotal(0);
    patenteActual = '';
}

function mostrarLoading() {
    document.getElementById('tablaPresupuestos').innerHTML =
        `<tr><td colspan="5" class="text-center">Cargando...</td></tr>`;
}

function mostrarErrorTabla(mensaje) {
    const tbody = document.getElementById('tablaPresupuestos');
    tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">${mensaje}</td></tr>`;
    actualizarTotal(0);
}

function renderizarTabla(presupuestos, total) {
    const tbody = document.getElementById('tablaPresupuestos');
    if (!presupuestos || presupuestos.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">
            No hay items para esta patente en la fecha actual.</td></tr>`;
        actualizarTotal(0);
        return;
    }

    let html = presupuestos.map(item => {
        const fecha = new Date(item.fecha).toLocaleDateString('es-AR');
        return `
            <tr>
                <td>${fecha}</td>
                <td>${item.marca} ${item.modelo}<br><small class="text-muted">${item.patente}</small></td>
                <td>${item.parte}</td>
                <td>$${parseFloat(item.importe).toFixed(2)}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="eliminarItem(${item.id_presu})" title="Eliminar item">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
    }).join('');
    tbody.innerHTML = html;
    actualizarTotal(total);
}

function actualizarTotal(monto) {
    document.getElementById('totalPresupuesto').textContent = `$${monto.toFixed(2)}`;
}

// Elimina un item con confirmaci√≥n y actualizaci√≥n de la tabla
function eliminarItem(id_presu) {
    Swal.fire({
        title: '¬øEliminar este item?',
        text: "Esta acci√≥n no se puede deshacer",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar',
        focusCancel: true
    }).then(result => {
        if (!result.isConfirmed) return;

        Swal.fire({
            title: 'Eliminando...',
            text: 'Por favor espere',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        fetch('/eliminar_item', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id_presu })
        })
        .then(response => {
            if (!response.ok) throw new Error(`Error en la respuesta: ${response.status}`);
            return response.json();
        })
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: '¬°Eliminado!',
                    text: 'El item ha sido eliminado correctamente',
                    timer: 2000,
                    timerProgressBar: true,
                    confirmButtonColor: '#28a745'
                });
                actualizarPresupuestos();
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        })
        .catch(error => {
            console.error('Error al eliminar item:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: `Error al eliminar el item: ${error.message}`,
                confirmButtonColor: '#dc3545'
            });
        });
    });
}

// Evento para agregar item
function manejarEnvioFormulario(event) {
    event.preventDefault();
   
    const form = event.target;
    const formData = new FormData(form);

    const partes = document.getElementById("partes").value.trim();
    const item = document.getElementById("item").value.trim();
   
    const requiredFields = ['marca', 'modelo', 'patente', 'accion'];

    for (let field of requiredFields) {
        if (!formData.get(field) || formData.get(field).trim() === '') {
            Swal.fire({
                icon: 'warning',
                title: 'Campo requerido',
                text: `El campo ${field} es obligatorio`,
                confirmButtonColor: '#ffc107'
            });
            return;
        }
    }


    if (partes === "" && item === "") {
        Swal.fire({
            icon: 'warning',
            title: 'Campo requerido',
            text: 'Debe completar una parte o escribir un √≠tem',
            confirmButtonColor: '#ffc107'
        });
        return;
    }

    let importe = document.getElementById("importe").value.trim();
    if (importe === "") {
        importe = "0";
    }
    /* SACO LA VALIDACION DEL IMPORTE >= 0  */
    /* const importe = parseFloat(formData.get('importe'));
    if (isNaN(importe) || importe <= 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Importe inv√°lido',
            text: 'El importe debe ser un n√∫mero mayor a 0',
            confirmButtonColor: '#ffc107'
        });
        return;
    } */

    Swal.fire({
        title: 'Agregando item...',
        text: 'Por favor espere',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });

    fetch('/agregar_item', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            id_cli: document.getElementById("id_cli").value,
            marca: document.getElementById("marca").value,
            modelo: document.getElementById("modelo").value,
            patente: document.getElementById("patente").value,
            accion: document.getElementById("accion").value,
            partes: partes,
            item: item,
            lateral: document.getElementById("lateral").value,
            importe: importe
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire('√âxito', data.message, 'success');
            // Actualiza tabla tras agregar
            actualizarPresupuestos();
            // Opcional: limpiar campos o reset form
            //document.getElementById("presupuestoForm").reset();
            // üí° Esta parte reemplaza al reset:
            const marca = document.getElementById("marca").value;
            const modelo = document.getElementById("modelo").value;
            const patente = document.getElementById("patente").value;

            document.getElementById("accion").value = "";
            document.getElementById("partes").value = "";
            document.getElementById("lateral").value = "";
            document.getElementById("importe").value = "";
            document.getElementById("item").value = "";
            
            document.getElementById("marca").value = marca;
            document.getElementById("modelo").value = modelo;
            document.getElementById("patente").value = patente;
        } else {
            Swal.fire('Error', data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error al enviar el item:', error);
        Swal.fire('Error', 'Ocurri√≥ un error al enviar el item', 'error');
    });
}

// Escuchar eventos despu√©s de cargar la p√°gina
document.addEventListener('DOMContentLoaded', () => {
    const patenteInput = document.getElementById('patente');
    const form = document.getElementById('presupuestoForm');

    if (patenteInput) {
        patenteInput.addEventListener('input', () => {
            if (patenteInput.value.trim() === '') limpiarTabla();
        });
        patenteInput.addEventListener('change', actualizarPresupuestos);
        patenteInput.addEventListener('blur', actualizarPresupuestos);
    }

    if (form) {
        form.addEventListener('submit', manejarEnvioFormulario);
    }
});

function imprimirPresupuesto() {
    const clienteNombre = document.getElementById("cliente_nombre").textContent;
    const clienteTelefono = document.getElementById("cliente_telefono").textContent;
    const clienteEmail = document.getElementById("cliente_email").textContent;

    const marca = document.getElementById("marca").value;
    const modelo = document.getElementById("modelo").value;
    const patente = document.getElementById("patente").value;

    const totalPresupuesto = document.getElementById("totalPresupuesto").textContent;

    const tablaOriginal = document.getElementById("grilla_items");
    const tablaClon = tablaOriginal.cloneNode(true);

    // Identificar √≠ndices de columnas a eliminar: Fecha y Veh√≠culo
    const encabezados = tablaClon.rows[0];
    let indexFecha = -1;
    let indexVehiculo = -1;

    for (let i = 0; i < encabezados.cells.length; i++) {
        const texto = encabezados.cells[i].textContent.trim().toLowerCase();
        if (texto === "fecha") indexFecha = i;
        if (texto === "veh√≠culo" || texto === "vehiculo") indexVehiculo = i;
    }

    // Eliminar columnas Fecha y Veh√≠culo y columna "Acciones"
    tablaClon.querySelectorAll("tr").forEach(row => {
        if (indexVehiculo !== -1 && row.cells.length > indexVehiculo) {
            row.deleteCell(indexVehiculo);
        }
        if (indexFecha !== -1 && row.cells.length > indexFecha) {
            row.deleteCell(indexFecha);
        }
        if (row.cells.length > 0) {
            row.deleteCell(-1);  // Elimina √∫ltima celda (Acciones)
        }
    });

    // Insertar fila "M√°s da√±os a verificar"
    const totalColumnas = tablaClon.rows[0].cells.length;
    const filaExtra = tablaClon.insertRow();
    const celdaExtra = filaExtra.insertCell(0);
    celdaExtra.colSpan = totalColumnas;
    celdaExtra.textContent = "M√°s da√±os a verificar";
    celdaExtra.style.fontWeight = "bold";
    celdaExtra.style.fontStyle = "italic";
    celdaExtra.style.textAlign = "center";

    // Agregar fila de Total
    const nuevaFila = tablaClon.insertRow();
    const celdaLabel = nuevaFila.insertCell(0);
    celdaLabel.colSpan = totalColumnas - 1;
    celdaLabel.textContent = "TOTAL:";
    celdaLabel.style.fontWeight = "bold";

    const celdaTotal = nuevaFila.insertCell(1);
    celdaTotal.textContent =  totalPresupuesto;
    celdaTotal.style.fontWeight = "bold";

    const grillaHTML = tablaClon.innerHTML;

    const ventana = window.open('', '_blank');
    ventana.document.write(`
        <html>
        <head>
            <title>Presupuesto</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .logo { width: 150px; }
                h2 { margin-bottom: 5px; } /* menos espacio abajo */
                h4 { margin-bottom: 5px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                table, th, td { border: 1px solid black; }
                th, td { padding: 8px; text-align: left; }
                .contacto { margin-top: 10px; font-size: 14px; }
                .datos-fiscales {
                    border: 1px solid #ccc;
                    border-radius: 10px;
                    padding: 10px 20px;
                    width: 300px;
                    margin-top: 5px; /* menos espacio arriba */
                    margin-bottom: 20px;
                    margin-left: auto;
                    box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
                    text-align: right;
                    font-size: 12px;
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                }
                .fila-dato {
                    display: flex;
                    justify-content: space-between;
                    font-size: 12px;
                }
                .fila-dato .label {
                    text-align: left;
                    font-weight: bold;
                }
                .fila-dato .valor {
                    text-align: right;
                }
            </style>
        </head>
        <body>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <img src="/static/images/logo_cira.png" alt="Logo CIRA" class="logo">
                <h2 style="margin: 0;">Presupuesto</h2>
            </div>

            <div class="datos-fiscales">
                <div class="fila-dato"><span class="label">CUIT:</span><span class="valor">30-70047456-3</span></div>
                <div class="fila-dato"><span class="label">ING. BRUTOS:</span><span class="valor">30-70047456-3</span></div>
                <div class="fila-dato"><span class="label">MUNICIPAL:</span><span class="valor">4536</span></div>
                <div class="fila-dato"><span class="label">FECHA INICIO ACT. :</span><span class="valor">01/03/2008</span></div>
            </div>

            <div class="contacto">Urquiza 385 - Tel: 0336-4661335 - Email: cirasrl@hotmail.com</div>
            <hr style="margin: 15px 0; border: 1px solid #000;">
            <h4>Cliente: ${clienteNombre}</h4>
            <h4>Tel√©fono: ${clienteTelefono}</h4>
            <h4>Email: ${clienteEmail}</h4>
            <h4>Fecha: ${new Date().toLocaleDateString()}</h4>
            <h4>Veh√≠culo: ${marca} ${modelo} - Patente: ${patente}</h4>
            <table>${grillaHTML}</table>
        </body>
        </html>
    `);
    ventana.document.close();
    ventana.print();
}


</script>


{% endblock %}